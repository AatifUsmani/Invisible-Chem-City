# Invisible City — Quickstart

Step-by-step guide to run the project locally and deploy the showcase website.

---

## What you need

- **Node.js** 18+ (for the web app)
- **Python** 3.9+ (for data pipeline and scripts)
- **Mapbox account** (free) for the map — [sign up](https://account.mapbox.com/auth/signup/)

---

## The only API: Mapbox

The web app uses **Mapbox** for the dark Toronto base map. There are no other APIs.

1. Go to [https://account.mapbox.com/](https://account.mapbox.com/).
2. Sign up or log in.
3. Open **Access tokens**.
4. Copy your **Default public token** (starts with `pk.`).

You will use this as `VITE_MAPBOX_TOKEN` below. No payment is required for normal use; the free tier is enough.

**Other APIs?** None. The app does not call any other external APIs. Facility data is loaded from the static file `web/public/data/facilities.json` (generated by the Python scripts).

---

## Two ways to get data

### Option A: Use the included sample data (fastest)

The repo already has:

- `data/raw/` — sample facilities and releases (CSV)
- `data/processed/` — cleaned + risk + anomaly (from running the pipeline once)
- `web/public/data/facilities.json` — data the website loads

You can run the **web app only** with this. If you want to regenerate everything (e.g. after changing the pipeline):

```bash
# From project root
pip install -r requirements.txt
python run_all.py
python scripts/export_web_data.py
```

That updates `data/processed/` and `web/public/data/facilities.json`.

### Option B: Use your own Toronto Chemtrac data

1. Download data from [Toronto Open Data – Chemical tracking (Chemtrac)](https://open.toronto.ca/dataset/chemical-tracking-chemtrac/).
2. Put the main CSV (e.g. facility/report data) in `data/raw/`.  
   If you have a second CSV with chemical names/descriptions, put it in `data/raw/` too (e.g. `chemical_tracking.csv`).
3. Run the ingestion script:

   ```bash
   pip install pandas   # if not already
   python scripts/ingest_chemtrac.py
   ```

   This writes `web/public/data/facilities.json`. If your CSV has different column names, use:

   ```bash
   python scripts/ingest_chemtrac.py --facility-csv data/raw/your_file.csv
   ```

   You can edit `scripts/ingest_chemtrac.py` and change `FACILITY_ALIASES` to match your columns.

4. (Optional) To also run the full ML pipeline (risk scoring, anomaly detection) on your data, you’d need to align your CSVs with the format expected by the notebooks (facilities + releases). Otherwise the website will still work with the JSON produced by `ingest_chemtrac.py`.

---

## Run the web app locally

All commands from the **project root** unless stated.

1. **Create the env file and add your Mapbox token**

   ```bash
   cp web/.env.example web/.env
   ```

   Open `web/.env` and replace the placeholder with your real token:

   ```
   VITE_MAPBOX_TOKEN=pk.eyJ1IjoieW91ci11c2VybmFtZSI...
   ```

   (No quotes, no spaces.)

2. **Install dependencies and start the dev server**

   ```bash
   cd web
   npm install
   npm run dev
   ```

3. Open the URL shown in the terminal (e.g. `http://localhost:5173`).  
   You should see the dark Toronto map and facility clouds. If you see “Add VITE_MAPBOX_TOKEN…”, the app didn’t get the token — check that the file is `web/.env` and the variable name is exactly `VITE_MAPBOX_TOKEN`.

---

## Deploy the website

### Vercel (recommended)

1. Push the repo to GitHub (or connect your repo to Vercel another way).
2. In [Vercel](https://vercel.com): **Add New Project** → import the repo.
3. **Root Directory**: click **Edit** next to the root path and set it to **`web`** (so Vercel builds and deploys only the React app). Leave **Build Command** and **Output Directory** as default (Vite will use `dist`).
4. **Environment variables**: add one variable:
   - **Name:** `VITE_MAPBOX_TOKEN`  
   - **Value:** your Mapbox public token (starts with `pk.`)
5. Deploy. Vercel will run `npm install` and `npm run build` in the `web` folder and serve the built app.

No other API keys or config are needed. The app loads `public/data/facilities.json` from the same deployment (no separate API server).

### Docker

Use this when you want to run the app in a container (e.g. on AWS ECS, a VPS, or locally).

1. **Make sure the web app has data.** Either:
   - leave the existing `web/public/data/facilities.json` in the repo, or
   - run `python scripts/export_web_data.py` (or `ingest_chemtrac.py`) so that `web/public/data/facilities.json` exists and is up to date.

2. **Build and run from project root**

   ```bash
   docker build -t invisible-city .
   docker run -p 8080:80 invisible-city
   ```

3. Open **http://localhost:8080**. The image serves the built site with nginx; no Node or Python needed at runtime.

---

## What each part of the repo is for

| Path | Purpose |
|------|--------|
| **web/** | The showcase website (React + Vite + Mapbox). This is what you run and deploy. |
| **web/public/data/facilities.json** | Data the website loads. Update via `export_web_data.py` or `ingest_chemtrac.py`. |
| **data/raw/** | Input CSVs (sample or your Chemtrac files). |
| **data/processed/** | Output of the Python pipeline (cleaned + risk + anomaly). |
| **notebooks/** | Analysis (cleaning, risk model, anomaly detection). For judges/portfolio. |
| **scripts/** | `run_pipeline.py` = pipeline; `export_web_data.py` = CSV → JSON for web; `ingest_chemtrac.py` = Chemtrac CSVs → JSON; `build_map.py` = static HTML map; `generate_sample_data.py` = sample CSVs. |
| **run_all.py** | One command: run pipeline + static map. Then run `export_web_data.py` to refresh the web app’s JSON. |
| **output/** | Static map (`map.html`) and charts. Optional; the main showcase is the web app. |

---

## Troubleshooting

- **Map is blank or “Add VITE_MAPBOX_TOKEN”**  
  Create `web/.env` with `VITE_MAPBOX_TOKEN=pk.your...` and restart `npm run dev`. On Vercel, add the same variable in project settings.

- **No facilities on the map**  
  Check that `web/public/data/facilities.json` exists and has a non-empty array. Regenerate with `python scripts/export_web_data.py` (after `run_all.py`) or `python scripts/ingest_chemtrac.py`.

- **Docker build fails**  
  Build must be run from the **project root** (where `Dockerfile` and `web/` are). Ensure `web/public/data/facilities.json` exists before building.

- **Vercel build fails**  
  Set **Root Directory** to `web`. Ensure `VITE_MAPBOX_TOKEN` is set in the Vercel project (Environment Variables).
